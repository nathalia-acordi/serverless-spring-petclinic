service: petclinic-serverless
configValidationMode: warn
frameworkVersion: '4'

plugins:
  - serverless-offline

provider:
  name: aws
  runtime: java17
  stage: ${opt:stage, 'local'}
  region: ${opt:region, 'sa-east-1'}
  profile: ${env:SLS_AWS_PROFILE, 'offline'}
  memorySize: 512
  timeout: 15
  versionFunctions: ${self:provider.stage} != 'local'
  environment:
    POWERTOOLS_SERVICE_NAME: petclinic
    POWERTOOLS_METRICS_NAMESPACE: Petclinic
    POWERTOOLS_LOGGER_LOG_EVENT: true
    LOG_LEVEL: INFO
    ENVIRONMENT_TYPE: ${self:provider.stage}
    DB_SECRET_ARN: ${ssm:/petclinic/${self:provider.stage}/db/secret-arn, 'local-test'}
    DB_PROXY_ENDPOINT: ${ssm:/petclinic/${self:provider.stage}/db/proxy-endpoint, 'localhost:3306'}
    DB_NAME: petclinic
    DB_USERNAME: ${env:DB_USERNAME, 'sa'}
    DB_PASSWORD: ${env:DB_PASSWORD, ''}
    DB_JDBC_URL: ${env:DB_JDBC_URL, 'jdbc:h2:mem:testdb'}
    DB_DRIVER: ${env:DB_DRIVER, 'org.h2.Driver'}
  vpc:
    securityGroupIds:
      - sg-0ef0c6b57f1ff926c
    subnetIds:
      - subnet-088a4cc9e6a86fe74
      - subnet-08d551fc4c79a039e
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - secretsmanager:GetSecretValue
          Resource:
            - arn:aws:secretsmanager:sa-east-1:151509777978:secret:petclinic/dev/mysql-*

custom:
  serverless-offline:
    httpPort: 3000
    reloadHandler: true
    ignoreJavaDeprecation: true
    websocketPort: 3001

package:
  individually: true
  patterns:
    - '!**/*.md'
    - '!**/test/**'

functions:
  owners-create:
    handler: org.springframework.cloud.function.adapter.aws.FunctionInvoker::handleRequest
    description: Create Owner (POST /owners)
    package:
      artifact: ../functions/owners-create/target/owners-create.jar
    snapStart: true
    environment:
      MAIN_CLASS: com.example.petclinic.functions.owners.create.OwnersCreateConfig
      SPRING_CLOUD_FUNCTION_DEFINITION: ownersCreate
    events:
      - httpApi:
          path: /owners
          method: post

  owners-list:
    handler: org.springframework.cloud.function.adapter.aws.FunctionInvoker::handleRequest
    description: List Owners (GET /owners)
    package:
      artifact: ../functions/owners-list/target/owners-list.jar
    snapStart: true
    environment:
      MAIN_CLASS: com.example.petclinic.functions.owners.list.OwnersListConfig
      SPRING_CLOUD_FUNCTION_DEFINITION: ownersList
    events:
      - httpApi:
          path: /owners
          method: get

  owners-get:
    handler: org.springframework.cloud.function.adapter.aws.FunctionInvoker::handleRequest
    description: Get Owner (GET /owners/{id})
    package:
      artifact: ../functions/owners-get/target/owners-get.jar
    snapStart: true
    environment:
      MAIN_CLASS: com.example.petclinic.functions.owners.get.OwnersGetConfig
      SPRING_CLOUD_FUNCTION_DEFINITION: ownersGet
    events:
      - httpApi:
          path: /owners/{id}
          method: get

  owners-update:
    handler: org.springframework.cloud.function.adapter.aws.FunctionInvoker::handleRequest
    description: Update Owner (PUT /owners/{id})
    package:
      artifact: ../functions/owners-update/target/owners-update.jar
    snapStart: true
    environment:
      MAIN_CLASS: com.example.petclinic.functions.owners.update.OwnersUpdateConfig
      SPRING_CLOUD_FUNCTION_DEFINITION: ownersUpdate
    events:
      - httpApi:
          path: /owners/{id}
          method: put

  visits-create:
    handler: org.springframework.cloud.function.adapter.aws.FunctionInvoker::handleRequest
    description: Create Visit (POST /owners/{ownerId}/pets/{petId}/visits)
    package:
      artifact: ../functions/visits-create/target/visits-create.jar
    snapStart: true
    environment:
      MAIN_CLASS: com.example.petclinic.functions.visits.create.VisitServiceConfiguration
      SPRING_CLOUD_FUNCTION_DEFINITION: createVisitFunction
    events:
      - httpApi:
          path: /owners/{ownerId}/pets/{petId}/visits
          method: post

  vets-list:
    handler: org.springframework.cloud.function.adapter.aws.FunctionInvoker::handleRequest
    description: List Vets (GET /vets)
    package:
      artifact: ../functions/vets-list/target/vets-list.jar
    snapStart: true
    environment:
      MAIN_CLASS: com.example.petclinic.functions.vets.list.VetServiceConfiguration
      SPRING_CLOUD_FUNCTION_DEFINITION: listVetsFunction
    events:
      - httpApi:
          path: /vets
          method: get

  pets-create:
    handler: org.springframework.cloud.function.adapter.aws.FunctionInvoker::handleRequest
    description: Create Pet (POST /owners/{ownerId}/pets)
    package:
      artifact: ../functions/pets-create/target/pets-create.jar
    snapStart: true
    environment:
      MAIN_CLASS: com.example.petclinic.functions.pets.create.CreatePetFunction
      SPRING_CLOUD_FUNCTION_DEFINITION: createPet
    events:
      - httpApi:
          path: /owners/{ownerId}/pets
          method: post

  pets-update:
    handler: org.springframework.cloud.function.adapter.aws.FunctionInvoker::handleRequest
    description: Update Pet (PUT /owners/{ownerId}/pets/{petId})
    package:
      artifact: ../functions/pets-update/target/pets-update.jar
    snapStart: true
    environment:
      MAIN_CLASS: com.example.petclinic.functions.pets.update.UpdatePetFunction
      SPRING_CLOUD_FUNCTION_DEFINITION: updatePet
    events:
      - httpApi:
          path: /owners/{ownerId}/pets/{petId}
          method: put
